# Deployment Guide - HEMIS University Management System

## Overview

This guide provides step-by-step instructions for deploying the HEMIS University Management System to production environments.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Environment Setup](#environment-setup)
3. [Docker Deployment](#docker-deployment)
4. [Kubernetes Deployment](#kubernetes-deployment)
5. [Database Setup](#database-setup)
6. [Post-Deployment](#post-deployment)
7. [Monitoring & Maintenance](#monitoring--maintenance)

## Prerequisites

### System Requirements

**Minimum:**
- CPU: 2 cores
- RAM: 4GB
- Storage: 20GB SSD
- OS: Ubuntu 22.04 LTS or similar

**Recommended:**
- CPU: 4+ cores
- RAM: 8GB+
- Storage: 50GB+ SSD
- OS: Ubuntu 22.04 LTS

### Software Requirements

```bash
# PHP 8.3+
php -v

# Composer 2.x
composer --version

# PostgreSQL 14+ or MySQL 8+
psql --version

# Redis 7+
redis-cli --version

# Nginx or Apache
nginx -v

# Docker (for containerized deployment)
docker --version
docker-compose --version
```

## Environment Setup

### 1. Clone Repository

```bash
git clone https://github.com/FeruzLatifov/univer-back.git
cd univer-back
```

### 2. Install Dependencies

```bash
# Install PHP dependencies
composer install --no-dev --optimize-autoloader

# Generate application key
php artisan key:generate

# Generate JWT secret
php artisan jwt:secret
```

### 3. Configure Environment

```bash
# Copy environment file
cp .env.example .env

# Edit environment file
nano .env
```

**Production .env Configuration:**
```env
# Application
APP_NAME="HEMIS University Management"
APP_ENV=production
APP_KEY=base64:...  # Generated by key:generate
APP_DEBUG=false
APP_URL=https://api.yourdomain.com
APP_TIMEZONE=Asia/Tashkent
APP_LOCALE=uz

# Database
DB_CONNECTION=pgsql
DB_HOST=your-db-host
DB_PORT=5432
DB_DATABASE=hemis_prod
DB_USERNAME=hemis_user
DB_PASSWORD=strong-password-here
DB_SSLMODE=require

# Cache & Session (Redis)
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis

REDIS_HOST=your-redis-host
REDIS_PASSWORD=redis-password
REDIS_PORT=6379

# JWT Authentication
JWT_SECRET=your-jwt-secret-here  # Generated by jwt:secret
JWT_TTL=60
JWT_REFRESH_TTL=20160

# Security
FORCE_HTTPS=true
SESSION_SECURE_COOKIE=true
SESSION_HTTP_ONLY=true

# Sentry (Error Tracking)
SENTRY_LARAVEL_DSN=your-sentry-dsn
SENTRY_TRACES_SAMPLE_RATE=0.1

# File Storage
FILESYSTEM_DISK=s3  # Or local/public

# AWS S3 (if using S3)
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=
AWS_BUCKET=

# Email
MAIL_MAILER=smtp
MAIL_HOST=smtp.yourdomain.com
MAIL_PORT=587
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@yourdomain.com
MAIL_FROM_NAME="${APP_NAME}"
```

### 4. Set Permissions

```bash
# Set ownership
sudo chown -R www-data:www-data /path/to/univer-back

# Set directory permissions
sudo find /path/to/univer-back -type d -exec chmod 755 {} \;
sudo find /path/to/univer-back -type f -exec chmod 644 {} \;

# Storage and cache directories (writable)
sudo chmod -R 775 storage bootstrap/cache
sudo chown -R www-data:www-data storage bootstrap/cache
```

## Docker Deployment

### 1. Build Docker Image

```bash
# Build image
docker build -t hemis/univer-backend:latest .

# Or using docker-compose
docker-compose build
```

### 2. Configure docker-compose.yml

```yaml
version: '3.8'

services:
  app:
    image: hemis/univer-backend:latest
    container_name: hemis-api
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ./:/var/www
      - ./docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini
    networks:
      - hemis-network
    depends_on:
      - db
      - redis
    environment:
      - DB_HOST=db
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis

  nginx:
    image: nginx:alpine
    container_name: hemis-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./:/var/www
      - ./docker/nginx/conf.d:/etc/nginx/conf.d
      - ./docker/nginx/ssl:/etc/nginx/ssl
    networks:
      - hemis-network
    depends_on:
      - app

  db:
    image: postgres:16
    container_name: hemis-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - hemis-network
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    container_name: hemis-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redisdata:/data
    networks:
      - hemis-network
    ports:
      - "6379:6379"

networks:
  hemis-network:
    driver: bridge

volumes:
  pgdata:
    driver: local
  redisdata:
    driver: local
```

### 3. Deploy with Docker Compose

```bash
# Start services
docker-compose up -d

# Run migrations
docker-compose exec app php artisan migrate --force

# Seed database (if needed)
docker-compose exec app php artisan db:seed --force

# Optimize application
docker-compose exec app php artisan optimize

# Check status
docker-compose ps
```

## Kubernetes Deployment

### 1. Create Namespace

```bash
kubectl create namespace hemis-prod
```

### 2. Create Secrets

```bash
# Create secret for database credentials
kubectl create secret generic hemis-db-secret \
  --from-literal=username=hemis_user \
  --from-literal=password=strong-password \
  -n hemis-prod

# Create secret for application
kubectl create secret generic hemis-app-secret \
  --from-literal=app-key=base64:... \
  --from-literal=jwt-secret=... \
  -n hemis-prod
```

### 3. Deploy Database (PostgreSQL)

**k8s/postgres-deployment.yaml:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: hemis-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:16
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: hemis_prod
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: hemis-db-secret
              key: username
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: hemis-db-secret
              key: password
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: postgres-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: hemis-prod
spec:
  selector:
    app: postgres
  ports:
    - port: 5432
      targetPort: 5432
  type: ClusterIP
```

### 4. Deploy Application

**k8s/app-deployment.yaml:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hemis-api
  namespace: hemis-prod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: hemis-api
  template:
    metadata:
      labels:
        app: hemis-api
    spec:
      containers:
      - name: hemis-api
        image: hemis/univer-backend:latest
        ports:
        - containerPort: 9000
        env:
        - name: APP_ENV
          value: "production"
        - name: DB_HOST
          value: "postgres"
        - name: DB_DATABASE
          value: "hemis_prod"
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: hemis-db-secret
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: hemis-db-secret
              key: password
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: hemis-api
  namespace: hemis-prod
spec:
  selector:
    app: hemis-api
  ports:
    - port: 80
      targetPort: 9000
  type: LoadBalancer
```

### 5. Deploy Ingress

**k8s/ingress.yaml:**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: hemis-ingress
  namespace: hemis-prod
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - api.yourdomain.com
    secretName: hemis-tls
  rules:
  - host: api.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: hemis-api
            port:
              number: 80
```

### 6. Apply Configurations

```bash
# Apply all configurations
kubectl apply -f k8s/

# Check deployment status
kubectl get pods -n hemis-prod
kubectl get services -n hemis-prod
kubectl get ingress -n hemis-prod

# Run migrations
kubectl exec -it deployment/hemis-api -n hemis-prod -- php artisan migrate --force

# Check logs
kubectl logs -f deployment/hemis-api -n hemis-prod
```

## Database Setup

### PostgreSQL

```bash
# Create database
createdb hemis_prod -U postgres

# Run migrations
php artisan migrate --force

# Seed initial data (if needed)
php artisan db:seed --class=RolesAndPermissionsSeeder --force
```

### Backup Strategy

```bash
# Daily backup script
#!/bin/bash
BACKUP_DIR="/backups/hemis"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/hemis_backup_$DATE.sql"

pg_dump -U hemis_user hemis_prod > $BACKUP_FILE
gzip $BACKUP_FILE

# Keep only last 7 days
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

## Post-Deployment

### 1. Cache Configuration

```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Optimize autoloader
composer dump-autoload --optimize
```

### 2. Queue Workers

```bash
# Start queue worker (supervisor config)
# /etc/supervisor/conf.d/hemis-worker.conf

[program:hemis-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/univer-back/artisan queue:work redis --sleep=3 --tries=3
autostart=true
autorestart=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/univer-back/storage/logs/worker.log
```

```bash
# Reload supervisor
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start hemis-worker:*
```

### 3. Scheduler (Cron)

```bash
# Add to crontab
crontab -e

# Add this line
* * * * * cd /var/www/univer-back && php artisan schedule:run >> /dev/null 2>&1
```

### 4. SSL Certificate

```bash
# Using Let's Encrypt
sudo certbot --nginx -d api.yourdomain.com

# Auto-renewal
sudo certbot renew --dry-run
```

### 5. Health Check

```bash
# Test health endpoint
curl https://api.yourdomain.com/up

# Test API endpoint
curl -X POST https://api.yourdomain.com/api/v1/employee/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'
```

## Monitoring & Maintenance

### Log Monitoring

```bash
# Application logs
tail -f storage/logs/laravel.log

# Nginx access logs
tail -f /var/log/nginx/access.log

# Nginx error logs
tail -f /var/log/nginx/error.log
```

### Performance Monitoring

**Sentry Dashboard:**
- https://sentry.io/your-project
- Monitor errors, performance, transactions

**Server Monitoring:**
```bash
# CPU and Memory usage
htop

# Disk usage
df -h

# Redis info
redis-cli INFO
```

### Backup Verification

```bash
# Weekly restore test
pg_restore -U hemis_user -d hemis_test backup.sql
```

### Security Updates

```bash
# Update dependencies
composer update --no-dev

# Security audit
composer audit

# System updates
sudo apt update
sudo apt upgrade
```

## Rollback Procedure

If deployment fails:

```bash
# 1. Revert to previous Docker image
docker-compose down
docker-compose pull previous-tag
docker-compose up -d

# 2. Or rollback database migrations
php artisan migrate:rollback --step=1

# 3. Clear caches
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
```

## Troubleshooting

### Common Issues

**Issue: 500 Internal Server Error**
```bash
# Check logs
tail -f storage/logs/laravel.log

# Check permissions
ls -la storage bootstrap/cache

# Clear caches
php artisan cache:clear
```

**Issue: Database Connection Failed**
```bash
# Test connection
php artisan tinker
>>> DB::connection()->getPdo();

# Check .env configuration
cat .env | grep DB_
```

**Issue: Queue Not Processing**
```bash
# Check worker status
sudo supervisorctl status hemis-worker:*

# Restart workers
sudo supervisorctl restart hemis-worker:*

# Check queue
php artisan queue:work --once
```

## Support

For deployment issues, contact:
- **DevOps Team:** devops@example.com
- **Technical Support:** support@example.com
- **On-Call:** +XXX-XXX-XXXX

---

**Document Version:** 1.0  
**Last Updated:** 2025-11-06  
**Maintained by:** DevOps Team
