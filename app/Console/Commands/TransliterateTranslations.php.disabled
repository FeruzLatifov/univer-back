<?php

namespace App\Console\Commands;

use App\Models\System\SystemMessage;
use App\Models\System\SystemMessageTranslation;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Cache;

/**
 * Transliterate uz-UZ to oz-UZ automatically
 * 
 * Usage:
 *   php artisan translation:transliterate
 *   php artisan translation:transliterate --force
 *   php artisan translation:transliterate --dry-run
 * 
 * Converts:
 *   uz-UZ (Latin): "Boshqaruv paneli"
 *   oz-UZ (Cyrillic): "Ğ‘Ğ¾ÑˆÒ›Ğ°Ñ€ÑƒĞ² Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸"
 */
class TransliterateTranslations extends Command
{
    /**
     * The name and signature of the console command.
     */
    protected $signature = 'translation:transliterate 
                            {--from=uz-UZ : Source language}
                            {--to=oz-UZ : Target language}
                            {--force : Overwrite existing translations}
                            {--dry-run : Show what would be transliterated without actually doing it}';

    /**
     * The console command description.
     */
    protected $description = 'Transliterate translations from Latin (uz-UZ) to Cyrillic (oz-UZ)';

    /**
     * Transliteration map (Latin â†’ Cyrillic)
     */
    protected $map = [
        // Uppercase
        'A' => 'Ğ', 'B' => 'Ğ‘', 'D' => 'Ğ”', 'E' => 'Ğ•', 'F' => 'Ğ¤',
        'G' => 'Ğ“', 'H' => 'Ò²', 'I' => 'Ğ˜', 'J' => 'Ğ–', 'K' => 'Ğš',
        'L' => 'Ğ›', 'M' => 'Ğœ', 'N' => 'Ğ', 'O' => 'Ğ', 'P' => 'ĞŸ',
        'Q' => 'Òš', 'R' => 'Ğ ', 'S' => 'Ğ¡', 'T' => 'Ğ¢', 'U' => 'Ğ£',
        'V' => 'Ğ’', 'X' => 'Ğ¥', 'Y' => 'Ğ™', 'Z' => 'Ğ—',
        
        // Special combinations (must be before single letters)
        'Sh' => 'Ğ¨', 'SH' => 'Ğ¨', 'sh' => 'Ñˆ',
        'Ch' => 'Ğ§', 'CH' => 'Ğ§', 'ch' => 'Ñ‡',
        
        // Lowercase
        'a' => 'Ğ°', 'b' => 'Ğ±', 'd' => 'Ğ´', 'e' => 'Ğµ', 'f' => 'Ñ„',
        'g' => 'Ğ³', 'h' => 'Ò³', 'i' => 'Ğ¸', 'j' => 'Ğ¶', 'k' => 'Ğº',
        'l' => 'Ğ»', 'm' => 'Ğ¼', 'n' => 'Ğ½', 'o' => 'Ğ¾', 'p' => 'Ğ¿',
        'q' => 'Ò›', 'r' => 'Ñ€', 's' => 'Ñ', 't' => 'Ñ‚', 'u' => 'Ñƒ',
        'v' => 'Ğ²', 'x' => 'Ñ…', 'y' => 'Ğ¹', 'z' => 'Ğ·',
        
        // English letters that stay same
        'C' => 'Ğ¦', 'c' => 'Ñ†',
        'W' => 'Ğ’', 'w' => 'Ğ²',
    ];

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $from = $this->option('from');
        $to = $this->option('to');
        $force = $this->option('force');
        $dryRun = $this->option('dry-run');

        $this->info("ğŸ”„ Transliterating: {$from} â†’ {$to}");
        $this->newLine();

        // Get all translations in source language
        $query = SystemMessageTranslation::where('language', $from)
            ->whereNotNull('translation')
            ->where('translation', '!=', '');

        if (!$force) {
            // Only transliterate if target translation is empty
            $query->whereDoesntHave('message', function ($q) use ($to) {
                $q->whereHas('translations', function ($q2) use ($to) {
                    $q2->where('language', $to)
                       ->whereNotNull('translation')
                       ->where('translation', '!=', '');
                });
            });
        }

        $translations = $query->get();

        if ($translations->isEmpty()) {
            $this->info('âœ… No translations to transliterate');
            return 0;
        }

        $this->info("ğŸ“Š Found {$translations->count()} translations to process");
        $this->newLine();

        // Progress bar
        $bar = $this->output->createProgressBar($translations->count());
        $bar->setFormat(' %current%/%max% [%bar%] %percent:3s%% %message%');
        $bar->setMessage('Starting...');
        $bar->start();

        $stats = [
            'processed' => 0,
            'created' => 0,
            'updated' => 0,
            'skipped' => 0,
        ];

        DB::beginTransaction();

        try {
            foreach ($translations as $translation) {
                $stats['processed']++;

                // Transliterate
                $transliterated = $this->transliterate($translation->translation);

                if (empty($transliterated)) {
                    $stats['skipped']++;
                    $bar->advance();
                    continue;
                }

                // Find or create target translation
                $target = SystemMessageTranslation::firstOrNew([
                    'id' => $translation->id,
                    'language' => $to,
                ]);

                $isNew = !$target->exists;

                if (!$dryRun) {
                    $target->translation = $transliterated;
                    $target->save();

                    if ($isNew) {
                        $stats['created']++;
                    } else {
                        $stats['updated']++;
                    }
                } else {
                    if ($isNew) {
                        $stats['created']++;
                    } else {
                        $stats['updated']++;
                    }
                }

                $bar->setMessage("Transliterated: {$translation->translation}");
                $bar->advance();
            }

            if (!$dryRun) {
                DB::commit();
                
                // Clear cache
                Cache::tags(['translations'])->flush();
                
                $bar->setMessage('âœ… Committed to database');
            } else {
                DB::rollBack();
                $bar->setMessage('ğŸ” Dry run completed (no changes)');
            }

        } catch (\Exception $e) {
            DB::rollBack();
            $bar->finish();
            $this->newLine(2);
            $this->error("âŒ Transliteration failed: " . $e->getMessage());
            return 1;
        }

        $bar->finish();

        // Summary
        $this->newLine(2);
        $this->info('ğŸ“Š Transliteration Summary:');
        $this->table(
            ['Metric', 'Count'],
            [
                ['Total processed', number_format($stats['processed'])],
                ['Created', number_format($stats['created'])],
                ['Updated', number_format($stats['updated'])],
                ['Skipped', number_format($stats['skipped'])],
            ]
        );

        if ($dryRun) {
            $this->newLine();
            $this->warn('ğŸ” This was a DRY RUN - no changes were made');
            $this->info('Run without --dry-run to actually transliterate');
        } else {
            $this->newLine();
            $this->info('âœ… Transliteration completed successfully!');
            $this->info('ğŸ—‘ï¸  Translation cache cleared');
        }

        return 0;
    }

    /**
     * Transliterate Latin to Cyrillic
     */
    protected function transliterate(string $text): string
    {
        // Replace special combinations first (sh, ch, oÊ», gÊ»)
        $specialCombinations = [
            'Sh' => 'Ğ¨',
            'SH' => 'Ğ¨',
            'sh' => 'Ñˆ',
            'Ch' => 'Ğ§',
            'CH' => 'Ğ§',
            'ch' => 'Ñ‡',
        ];

        $result = $text;
        
        foreach ($specialCombinations as $search => $replacement) {
            $result = str_replace($search, $replacement, $result);
        }

        // Handle special apostrophe characters (oÊ», gÊ»)
        $result = preg_replace('/[Oo]Ê»/u', 'Ğ', $result);
        $result = preg_replace('/[Oo]Ê¼/u', 'Ğ', $result);
        $result = preg_replace('/[Oo]\'/u', 'Ğ', $result);
        $result = preg_replace('/[oĞ¾]Ê»/u', 'Ñ', $result);
        $result = preg_replace('/[oĞ¾]Ê¼/u', 'Ñ', $result);
        $result = preg_replace('/[oĞ¾]\'/u', 'Ñ', $result);
        
        $result = preg_replace('/[Gg]Ê»/u', 'Ò’', $result);
        $result = preg_replace('/[Gg]Ê¼/u', 'Ò’', $result);
        $result = preg_replace('/[Gg]\'/u', 'Ò’', $result);
        $result = preg_replace('/[gĞ³]Ê»/u', 'Ò“', $result);
        $result = preg_replace('/[gĞ³]Ê¼/u', 'Ò“', $result);
        $result = preg_replace('/[gĞ³]\'/u', 'Ò“', $result);

        // Then replace single letters
        $result = strtr($result, $this->map);

        return $result;
    }
}
